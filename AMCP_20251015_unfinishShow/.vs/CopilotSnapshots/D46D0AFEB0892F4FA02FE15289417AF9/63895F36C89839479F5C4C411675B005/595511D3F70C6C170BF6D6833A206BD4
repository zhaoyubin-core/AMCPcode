using AForge.Controls;
using Emgu.CV;
using Emgu.CV.CvEnum;
using Emgu.CV.Structure;
using GxIAPINET;
using OpenCvSharp;
using OpenCvSharp.Flann;
using PMCLIB;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Drawing.Imaging;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Reflection.Emit;
using System.Runtime.InteropServices;
using System.Security.Cryptography;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Web.UI.WebControls;
using System.Windows.Forms;
using tscmcnet;
using static AMCP.FrmNozzleCalibrate;
using static System.Windows.Forms.VisualStyles.VisualStyleElement;
using CheckBox = System.Windows.Forms.CheckBox;
using TextBox = System.Windows.Forms.TextBox;

namespace AMCP
{
    public partial class FrmNozzleCalibrate : Form
    {

        double z2_connact = 0;    // 碰针位置（压力传感器接触临界位置：记录压力值在1~5之间时的Z坐标）
        double[] centerPoint = new double[3] { 0, 0, 0 };

        TextBox[] arr_txtPosHeight;
        CheckBox[] arr_chkPrintPos;

        public FrmNozzleCalibrate()
        {
            InitializeComponent();
            this.AutoScaleMode = AutoScaleMode.Dpi;
            arr_txtPosHeight = new TextBox[] { txtPosHeightA, txtPosHeightB };
            arr_chkPrintPos = new CheckBox[] { chkPrintPosA, chkPrintPosB };
        }

        private void FrmNozzleCalibrate_Enter(object sender, EventArgs e)
        {
            //// 更新打印开始位置
            //GetInitPos();
            //// 更新对针准备位置
            //GetAdjustPos();
            //// 根据当前喷头获取对针Z坐标
            //GetAdjustZ();
            //// 启动状态监测循环
            //timer2.Start();
        }

        public int step = 0;


        private void UpdateNoticeInfo()
        {
            // 更新通知信息
            if (GV.PrintingObj.NoticeInfo == "PositionReady")
            {
                lblNotice.Text = "已到达准备位置";
                lblNotice.BackColor = Color.Green;
                GV.PrintingObj.NoticeInfo = "";
                //btnNozzleCalibrate.Enabled = true;
                //btnNozzleCalibrate.BackColor = Color.LightGreen;
            }
            else if (GV.PrintingObj.NoticeInfo != "")
            {
                //btnNozzleCalibrate.Enabled = false;
                //btnNozzleCalibrate.BackColor = Color.White;
                if (GV.PrintingObj.NoticeInfo == "PrintReady")
                {
                    lblNotice.Text = "已到达打印开始位置";
                    lblNotice.BackColor = Color.Green;
                    GV.PrintingObj.NoticeInfo = "";
                }
            }
        }

        private void timer2_Tick(object sender, EventArgs e)
        {
            if (GV.PrintingObj.Status.nozzleID == 1)
            {
                rdbNozzle1.Checked = false;
                rdbNozzle2.Checked = true;
            }
            else
            {
                rdbNozzle1.Checked = true;
                rdbNozzle2.Checked = false;
            }
            GV.frmMotionAdjust.UpdateNozzleStatus();
        }



        private void btnMove2SetP_Click(object sender, EventArgs e)
        {
            if (GV.CheckClearCommands() == ClearResult.DonotClear) return;

            try
            {
                // 从文本框读取设定位置数据
                GV.xSet = Convert.ToDouble(txtAdjustX_A.Text);
                GV.ySet = Convert.ToDouble(txtAdjustY_A.Text);
                GV.zSet = Convert.ToDouble(txtAdjustZ_A.Text);
                // 从文本框读取设定速度数据
                double vSetXY = 30;
                double vSetZ = 20;

                // 获取当前位置数据
                GV.xFed = GV.PrintingObj.Status.fPosX; //Convert.ToDouble(txtFeedbackPos0.Text);
                GV.yFed = GV.PrintingObj.Status.fPosY; //Convert.ToDouble(txtFeedbackPos1.Text);
                GV.zFed = GV.PrintingObj.Status.fPosZ; //Convert.ToDouble(txtFeedbackPos2.Text);
                GV.PrintingObj.qMoveAxisTo(GV.Z, 0, vSetZ, GV.zFed);
                GV.PrintingObj.qWaitMoveEnd();
                GV.PrintingObj.qMoveAxisTo(GV.X, GV.xSet, vSetXY, GV.xFed);
                GV.PrintingObj.qMoveAxisTo(GV.Y, GV.ySet, vSetXY, GV.yFed);
                GV.PrintingObj.qWaitMoveEnd();
                GV.PrintingObj.qMoveAxisTo(GV.Z, GV.zSet, vSetZ / 5, GV.zFed);
            }
            catch (System.Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
        }

        private void btnSetAdjustPosAsCurrent_Click(object sender, EventArgs e)
        {
            try
            {
                GV.X_ADJUST = Convert.ToDouble(txtAdjustX_A.Text);
                GV.Y_ADJUST = Convert.ToDouble(txtAdjustY_A.Text);
                GV.Z_ADJUST = Convert.ToDouble(txtAdjustZ_A.Text);
                GV.X_ADJUST_B = Convert.ToDouble(txtAdjustX_B.Text);
                GV.Y_ADJUST_B = Convert.ToDouble(txtAdjustY_B.Text);
                GV.Z_ADJUST_B = Convert.ToDouble(txtAdjustZ_B.Text);
                GV.dX_AB = GV.X_ADJUST_B - GV.X_ADJUST;
                GV.dY_AB = GV.Y_ADJUST_B - GV.Y_ADJUST;
                GV.dZ_AB = GV.Z_ADJUST_B - GV.Z_ADJUST;
                GV.X_INIT = Convert.ToDouble(txtInitX.Text);
                GV.Y_INIT = Convert.ToDouble(txtInitY.Text);
                GV.Z_INIT = Convert.ToDouble(txtInitZ.Text);
                GV.Z_INTERVAL = Convert.ToDouble(nmud_d2.Value);
                SaveParameters();
            }
            catch (Exception)
            {
                txt_z0.Focus();
            }
        }

        public void GetInitPos()
        {
            txtInitX.Text = GV.X_INIT.ToString("0.000");
            txtInitY.Text = GV.Y_INIT.ToString("0.000");
            txt_z0.Text = GV.Z_INIT.ToString("0.000");
            txt_d3.Text = GV.Z_OFFSET.ToString("0.000");
            txt_z0.Text = GV.Z_BOTTOM.ToString("0.000");
            nmud_d2.Value = (decimal)GV.Z_INTERVAL;
        }

        public void SetInitPos()
        {
            try
            {
                GV.X_INIT = Convert.ToDouble(txtInitX.Text);
                GV.Y_INIT = Convert.ToDouble(txtInitY.Text);
                GV.Z_INIT = Convert.ToDouble(txt_z0.Text);
                GV.Z_OFFSET = Convert.ToDouble(txt_d3.Text);
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
        }

        public void GetAdjustPos()
        {
            // 双喷头校准位置
            txtAdjustX_A.Text = GV.X_ADJUST.ToString("0.000");
            txtAdjustY_A.Text = GV.Y_ADJUST.ToString("0.000");
            txtAdjustZ_A.Text = GV.Z_ADJUST.ToString("0.000");
            txtAdjustX_B.Text = GV.X_ADJUST_B.ToString("0.000");
            txtAdjustY_B.Text = GV.Y_ADJUST_B.ToString("0.000");
            txtAdjustZ_B.Text = GV.Z_ADJUST_B.ToString("0.000");
            // 摄像头校准位置差
            txtCameradX.Text = GV.dX_Camera.ToString("0.000");
            txtCameradY.Text = GV.dY_Camera.ToString("0.000");
            txtCameradZ.Text = GV.dZ_Camera.ToString("0.000");
            // 清洁装置校准位置差
            txtCleandX.Text = GV.dX_Clean.ToString("0.000");
            txtCleandY.Text = GV.dY_Clean.ToString("0.000");
            txtCleandZ.Text = GV.dZ_Clean.ToString("0.000");
        }

        public void SetAdjustPos()
        {
            try
            {
                GV.X_ADJUST = Convert.ToDouble(txtAdjustX_A.Text);
                GV.Y_ADJUST = Convert.ToDouble(txtAdjustY_A.Text);
                GV.Z_ADJUST = Convert.ToDouble(txtAdjustZ_A.Text);
                GV.X_ADJUST_B = Convert.ToDouble(txtAdjustX_B.Text);
                GV.Y_ADJUST_B = Convert.ToDouble(txtAdjustY_B.Text);
                GV.Z_ADJUST_B = Convert.ToDouble(txtAdjustZ_B.Text);
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
        }

        private void GetAdjustZ()
        {
            if (GV.PrintingObj.Status.nozzleID == 0) // 左喷头
            {
                txtVar_z2.Text = txtAdjustZ_A.Text;
            }
            else  // 右喷头
            {
                txtVar_z2.Text = txtAdjustZ_B.Text;
            }
        }

        private void SaveParameters()
        {
            try
            {
                GV.frmMotionAdjust.WriteAdvanConfigFile();
            }
            catch (Exception)
            {
            }
        }

        private void ReadParameters()
        {
            try
            {
                GV.frmMotionAdjust.ReadAdvanConfigFile();
            }
            catch (Exception)
            {
            }
        }

        /// <summary>
        /// 获取压力值
        /// </summary>
        /// <returns></returns>
        private int GetPressure()
        {
            int value = 0;
            try
            {
                byte[] sendBuffer = new byte[8];
                sendBuffer[0] = 170;
                sendBuffer[1] = 170;
                sendBuffer[2] = 170;
                sendBuffer[3] = 1;
                sendBuffer[4] = 161;
                sendBuffer[5] = 0;
                sendBuffer[6] = 0;
                sendBuffer[7] = 10;

                seriPortSensor1.Write(sendBuffer, 0, sendBuffer.Length);
                nNotReplay++;
                Thread.Sleep(50);

                return value;

            }
            catch (Exception ex)
            {
                return PRESSURE_ERR;
            }
        }

        private bool ZeroPressure()
        {
            try
            {
                step = 12;

                byte[] sendBuffer = new byte[8];
                sendBuffer[0] = 170;
                sendBuffer[1] = 170;
                sendBuffer[2] = 170;
                sendBuffer[3] = 1;
                sendBuffer[4] = 162;
                sendBuffer[5] = 0;
                sendBuffer[6] = 0;
                sendBuffer[7] = 9;
                Thread.Sleep(100);
                step = 13;
                seriPortSensor1.Write(sendBuffer, 0, sendBuffer.Length);
                step = 14;
                nNotReplay++;
                return true;
                //Thread.Sleep(100);

                //byte[] readBuff = new byte[10];
                //seriPortSensor1.Read(readBuff, 0, 10);


            }
            catch (Exception)
            {
                return false;
            }
        }

        private void btnOpenCOM2_Click(object sender, EventArgs e)
        {
            if (btnOpenCOM2.Text == "连接压力传感器")
            {
                try
                {
                    seriPortSensor1.Open();                     //打开串口
                    btnOpenCOM2.Text = "关闭连接";
                    panel2.Enabled = true;
                }
                catch (Exception ex)
                {
                    MessageBox.Show(ex.Message + "请对通信串口进行配置！");
                    panel2.Enabled = false;
                    return;
                }
            }
            else
            {
                seriPortSensor1.Close();
                btnOpenCOM2.Text = "连接压力传感器";
                panel2.Enabled = false;
            }

        }

        double zStep = 0.05;
        double vStep = 1;
        int direction = 1;

        private void SetZStep(int stepMicroMeter)
        {
            zStep = stepMicroMeter * 0.001;
            lblZStep.Text = (zStep * 1000).ToString("0");
        }

        private void HalfZStep()
        {
            zStep = zStep * 0.5;
            if (zStep < 0.0005)
            {
                zStep = 0.001;
            }
            else if (zStep > 0.01)
            {
                zStep = 0.01;
            }
            lblZStep.Text = (zStep * 1000).ToString("0");
        }

        const int PRESSURE_ERR = 30000;




        System.Windows.Forms.Timer tmrDelay;
        delegate void FuncHandler(object sender, EventArgs e);

        private void DelayCall(FuncHandler f, int delayMsec)//, object tag = null)
        {
            tmrDelay = new System.Windows.Forms.Timer();
            tmrDelay.Tick += new EventHandler(f);
            tmrDelay.Interval = delayMsec > 0 ? delayMsec : 1;
            //tmr.Tag = tag;
            tmrDelay.Start();
        }

        private void timer1_Tick(object sender, EventArgs e)
        {
            try
            {
                int percent = GV.PrintingObj.GetAdjustStatus();
                progressBar1.Value = percent;
                if (percent <= 0)
                {
                    lblNotice.Text = "尚未执行喷头校准程序";
                }
                if (percent > 0 && percent < 50)
                {
                    lblNotice.Text = "正在对喷头X/Z进行校准";
                    return;
                }
                else if (percent >= 50 && percent < 99)
                {
                    lblNotice.Text = "喷头X/Z校准完成，正在校准Y/Z";
                    return;
                }
                else if (percent == 100)
                {
                    centerPoint = GV.PrintingObj.GetLaserCenter();
                    if (centerPoint != null)
                    {
                        if (centerPoint.Length == 3 && centerPoint[0] == GV.PrintingObj.Status.fPosX && centerPoint[1] == GV.PrintingObj.Status.fPosY && centerPoint[2] == GV.PrintingObj.Status.fPosZ)
                        {
                            lblNotice.Text = "喷头对准成功！";
                            lblNotice.BackColor = Color.Green;
                            btnNozzleCalibrate.Text = "开始校准";
                            timer1.Stop();
                        }
                    }
                }
            }
            catch (Exception ex)
            {
            }
        }

        private void FrmNozzleCalibrate_FormClosing(object sender, FormClosingEventArgs e)
        {
            e.Cancel = (e.CloseReason == CloseReason.UserClosing);
            this.Hide();
        }

        private void btnResetStep_Click(object sender, EventArgs e)
        {
            timer1.Stop();
            SetZStep(50);
            ZeroPressure();
            lblNotice.Text = "喷头待对准";
            lblNotice.BackColor = Color.FromKnownColor(KnownColor.Control);
        }

        private void button12_Click(object sender, EventArgs e)
        {
            ZeroPressure();
        }

        private void button1_Click(object sender, EventArgs e)
        {
            if (!seriPortSensor1.IsOpen)
            {
                try
                {
                    seriPortSensor1.Open();
                }
                catch (Exception ex)
                {
                    MessageBox.Show(ex.Message);
                    return;
                }
            }
            timer1.Interval = (int)numericUpDown1.Value;
            vStep = (int)numericUpDown2.Value;
            direction = 1;
            timer1.Start();
        }

        private void button2_Click(object sender, EventArgs e)
        {
            timer1.Stop();
        }

        private void btnNozzleCalibrate_Click(object sender, EventArgs e)
        {
            try
            {
                if (timer1.Enabled)
                {
                    GV.PrintingObj.StopBuffer(6);
                    lblNotice.Text = "";
                    progressBar1.Hide();
                    lblNotice.BackColor = Color.Transparent;
                    timer1.Stop();
                    btnNozzleCalibrate.Text = "开始校准";
                }
                else
                {
                    DelayCall(StartAdjustNozzle_Tick, 100);
                    btnNozzleCalibrate.Text = "停止校准";
                }
            }
            catch (Exception ex)
            {
            }
        }


        /// <summary>
        /// 移动喷头到打印初始位置
        /// </summary>
        private void Move2InitPos()
        {
            if (GV.CheckClearCommands() == ClearResult.DonotClear) return;

            double vZup = 30;       // Z轴提针速度
            double vZdown1 = 10;     // Z轴第一阶段下针速度
            double vZdown2 = 2;     // Z轴第二阶段下针速度
            double vXY = 30;        // XY轴移动速度

            // 分4步移动到初始位置：
            // 第1步：快速将Z轴提高至最上面
            GV.PrintingObj.qMoveAxisTo(GV.Z, 0, vZup, 0);
            GV.PrintingObj.qWaitMoveEnd();

            // 第2步：将XY轴移动到初始位置
            GV.PrintingObj.qMoveXYTo(GV.X_INIT, GV.Y_INIT, vXY, 0, 0);
            GV.PrintingObj.qWaitMoveEnd();

            // 第3步：较慢速将Z轴降至接近初始位置
            GV.PrintingObj.qMoveAxisTo(GV.Z, GV.Z_INIT - 5, vZdown1, 0);  // 将Z轴降低至初始调针位置
            GV.PrintingObj.qWaitMoveEnd();

            // 第4步：非常慢速将Z轴降至初始位置
            GV.PrintingObj.qMoveAxisTo(GV.Z, GV.Z_INIT, vZdown2, 0);  // 将Z轴降低至初始调针位置
            GV.PrintingObj.qWaitMoveEnd();

            // 通知准备就绪
            GV.PrintingObj.qDisplayInfo("Notice", "PositionReady");
        }

        private void StartAdjustNozzle_Tick(object sender, EventArgs e)
        {
            try
            {
                progressBar1.Show();
                lblNotice.Text = "喷头正在对准中..";
                lblNotice.BackColor = Color.Red;
                GV.PrintingObj.RunNozzleCalibrate(checkBox1.Checked ? 2 : 1);
                timer1.Start();
                tmrDelay.Stop();
            }
            catch (Exception ex)
            {
            }
        }

        private void btnSetFPosAsAdjust_Click(object sender, EventArgs e)
        {

        }

        private void btnSetFPosAsInit_Click(object sender, EventArgs e)
        {

        }


        private void btnResetAdjust_Click(object sender, EventArgs e)
        {
            ReadParameters();
            GetAdjustPos();
            GetInitPos();
        }

        private void btnCancelAdjust_Click(object sender, EventArgs e)
        {
            timer1.Stop();
            SetZStep(50);
            ZeroPressure();
            lblNotice.BackColor = Color.FromKnownColor(KnownColor.Transparent);
            lblNotice.Text = "";
        }

        private void ResetFormStatus()
        {
            timer1.Stop();
            lblNotice.BackColor = Color.FromKnownColor(KnownColor.Transparent);
            btnNozzleCalibrate.Enabled = false;
            btnNozzleCalibrate.BackColor = Color.White;
            btnNozzleCalibrate.Text = "启动压感对针";
        }

        private void txtInit_Leave(object sender, EventArgs e)
        {
            SetInitPos();
        }

        private void btnMove2InitPos_Click(object sender, EventArgs e)
        {
            //Move2ReadyPos(GV.X_INIT, GV.Y_INIT, 5, "PrintReady");

            double vZup = 30;       // Z轴提针速度(mm/s)
            double vXY = 30;        // XY轴移动速度(mm/s)

            // 第1步：快速将Z轴升至提针位置（若当前位置高于目标位置则Z保持不动）
            if (GV.PrintingObj.Status.fPosZ > GV.Z_TOP)
            {
                GV.PrintingObj.qMoveAxisTo(GV.Z, GV.Z_TOP, vZup, 0);
                GV.PrintingObj.qWaitMoveEnd();
            }
            // 第2步：将XY轴移动到目标位置
            GV.PrintingObj.qMoveXYTo(GV.X_INIT, GV.Y_INIT, vXY, 0, 0);
            GV.PrintingObj.qWaitMoveEnd();
        }

        private void txtPos_Leave(object sender, EventArgs e)
        {
            try
            {
                TextBox txtPos = sender as TextBox;
                txtPos.Text = Convert.ToDouble(txtPos.Text).ToString("0.000");
                SetInitPos();
                SetAdjustPos();
            }
            catch (Exception)
            {
                (sender as Control).Focus();
            }
        }


        private void btnMove2ReadyPos_Click(object sender, EventArgs e)
        {
            double x, y, z;
            if (rdbNozzle2.Checked)
            {
                x = GV.X_ADJUST_B;
                y = GV.Y_ADJUST_B;
                z = GV.Z_ADJUST_B - 5; // 预留5mm安全距离
            }
            else
            {
                x = GV.X_ADJUST;
                y = GV.Y_ADJUST;
                z = GV.Z_ADJUST - 5; // 预留5mm安全距离
            }
            if (DialogResult.OK == MessageBox.Show("确定移动到坐标: (" + x.ToString("0") + ", "
                + y.ToString("0") + "," + z.ToString("0") + ") 吗？\r\n\r\n"
                + "如果您之前没有配置过左右喷头校准位置，请点击“取消”按钮，"
                + "并手动移动到喷头校准装置的十字正上方后，再点击“开始校准”。", "请注意", MessageBoxButtons.OKCancel, MessageBoxIcon.Exclamation))
            {
                Move2ReadyPos(x, y, z, "PositionReady");
            }
        }

        /// <summary>
        /// 移动到目标位置（先提针、平移、再下针）
        /// </summary>
        /// <param name="x">目标X</param>
        /// <param name="y">目标Y</param>
        /// <param name="z">目标Z</param>
        /// <param name="NoticeInfo">达到目标位置的通知消息</param>
        /// <returns>估计所需运动时间</returns>
        private int Move2ReadyPos(double x, double y, double z, string NoticeInfo)
        {
            if (GV.CheckClearCommands() != ClearResult.Needless) return 0;

            double vZup = 30;       // Z轴提针速度(mm/s)
            double vZdown1 = 10;     // Z轴第一阶段下针速度(mm/s)
            double vZdown2 = 2;     // Z轴第二阶段下针速度(mm/s)
            double vXY = 30;        // XY轴移动速度(mm/s)
            double dNear = 10;       // 接近减速距离(mm)
            // 估计运动至起始点的时间：
            double timeEstimate = 0;

            GV.PrintingObj.qDisplayInfo("Notice", "Moving");

            // 分4步移动到目标位置：
            // 第1步：快速将Z轴升至提针位置
            GV.PrintingObj.qMoveAxisTo(GV.Z, GV.Z_TOP, vZup, 0);
            GV.PrintingObj.qWaitMoveEnd();
            timeEstimate += (Math.Abs(GV.PrintingObj.Status.fPosZ - GV.Z_TOP) / vZup);  // 耗时估算

            // 第2步：将XY轴移动到目标位置
            GV.PrintingObj.qMoveXYTo(x, y, vXY, 0, 0);
            GV.PrintingObj.qWaitMoveEnd();
            timeEstimate += (Math.Sqrt(Math.Pow(GV.PrintingObj.Status.fPosX - x, 2) + Math.Pow(GV.PrintingObj.Status.fPosY - y, 2)) / vXY);  // 耗时估算
            // 第3步：较慢速将Z轴降至接近目标位置
            GV.PrintingObj.qMoveAxisTo(GV.Z, z - dNear, vZdown1, 0);
            GV.PrintingObj.qWaitMoveEnd();
            timeEstimate += (Math.Abs(z - dNear) / vZdown1);  // 耗时估算
            // 第4步：非常慢速将Z轴降至目标位置
            GV.PrintingObj.qMoveAxisTo(GV.Z, z, vZdown2, 0);
            GV.PrintingObj.qWaitMoveEnd();
            GV.PrintingObj.qDisplayInfo("Notice", NoticeInfo);
            timeEstimate += (5 / vZdown2);  // 耗时估算

            timeEstimate += 2;
            return (int)(timeEstimate * 1000);
        }




        bool JogMovingZ = false;

        private void JogMove(int direction)
        {
            if (GV.CheckClearCommands() != ClearResult.Needless) return;
            if (direction == 1)
            {
                GV.PrintingObj.Jog(GV.Z, 1);
            }
            else
            {
                GV.PrintingObj.Jog(GV.Z, -10);
            }
            JogMovingZ = true;
        }

        private void JogMove_Stop()
        {
            if (JogMovingZ)
            {
                GV.PrintingObj.Stop(GV.Z);
                JogMovingZ = false;
            }
        }

        private void btnNozzleDown_MouseDown(object sender, MouseEventArgs e)
        {
            JogMove(1);

        }

        private void btnNozzleDown_MouseUp(object sender, MouseEventArgs e)
        {
            JogMove_Stop();
        }

        private void btnNozzleUp_Click(object sender, EventArgs e)
        {
            if (GV.CheckClearCommands() != ClearResult.Needless) return;
            double curPos = GV.PrintingObj.GetFPosition(GV.Z);
            GV.PrintingObj.qMoveAxisTo(GV.Z, GV.Z_TOP, 30, curPos);
        }

        private void btnSensorPosCalibrate_Click(object sender, EventArgs e)
        {
            if (DialogResult.Cancel == MessageBox.Show("校准前请首先将喷头移动至打印开始位置，并用塞尺精确测量间隙。如果已完成此步骤，点击“确定”立即标定；点击“取消”重新准备", "标定确认", MessageBoxButtons.OKCancel, MessageBoxIcon.Exclamation, MessageBoxDefaultButton.Button2))
            {
                return;
            }
            double z1, z2, d1;
            double d3;
            z1 = Convert.ToDouble(txt_z1.Text);
            z2 = Convert.ToDouble(txt_z2.Text);
            d1 = Convert.ToDouble(nmud_d1.Value);
            d3 = z2 - z1 - d1;
            GV.Z_OFFSET = d3;
            txt_d3.Text = d3.ToString("0.000");


            //if (DialogResult.Cancel == MessageBox.Show("现在喷头正在移动至对针准备位置，喷头已经到达准备位置，点击“确定”启动压感对针程序；点击“取消”重新准备", "喷头是否已经到达对针准备位置？，", MessageBoxButtons.OKCancel, MessageBoxIcon.Exclamation, MessageBoxDefaultButton.Button2))
            //{
            //    return;
            //}

        }

        private void nmudHeight_ValueChanged(object sender, EventArgs e)
        {
            btnSensorPosCalibrate.Enabled = false;
            btnSensorPosCalibrate.BackColor = Color.White;
        }

        private void CalcuZ_BOTTOM()
        {
            try
            {
                double z0, z2, d2, d3;
                z2 = Convert.ToDouble(txtVar_z2.Text);
                d2 = (double)nmud_d2.Value;
                d3 = Convert.ToDouble(txtCon_d3.Text);
                GV.Z_OFFSET = d3;

                z0 = z2 - d3 - d2;
                GV.Z_BOTTOM = z0;
                txt_z0.Text = z0.ToString("0.000");
            }
            catch (Exception ex)
            {
            }
        }

        private void label21_Click(object sender, EventArgs e)
        {
            txt_z1.Text = GV.PrintingObj.Status.fPosZ.ToString("0.000");
        }

        private void label21_MouseMove(object sender, MouseEventArgs e)
        {
            label21.ForeColor = Color.Blue;
        }

        private void label21_MouseLeave(object sender, EventArgs e)
        {
            label21.ForeColor = Color.Black;
        }

        private void btnSave_Click(object sender, EventArgs e)
        {
            SaveParameters();
        }

        private void txt_d3_Leave(object sender, EventArgs e)
        {
            try
            {
                TextBox txt = sender as TextBox;
                GV.Z_OFFSET = Convert.ToDouble(txt.Text);
                txt.Text = GV.Z_OFFSET.ToString("0.000");
                txtCon_d3.Text = txt_d3.Text;
            }
            catch (Exception)
            {
                (sender as Control).Focus();
            }

        }

        private void txt_d3_TextChanged(object sender, EventArgs e)
        {
            try
            {
                TextBox txt = sender as TextBox;
                GV.Z_OFFSET = Convert.ToDouble(txt.Text);
                txt.Text = GV.Z_OFFSET.ToString("0.000");
                txtCon_d3.Text = txt_d3.Text;
                CalcuZ_BOTTOM();
            }
            catch (Exception)
            {
                (sender as Control).Focus();
            }

        }

        private void nmud_d2_ValueChanged(object sender, EventArgs e)
        {
            txt_d2.Text = nmud_d2.Value.ToString();
        }

        private void btnChangeNozzle_Click(object sender, EventArgs e)
        {
            Move2ReadyPos(GV.X_NOZZLE_CHANGE, GV.Y_NOZZLE_CHANGE, GV.Z_NOZZLE_CHANGE, "NOZZLE_CHANGE");
        }

        private void label20_MouseLeave(object sender, EventArgs e)
        {
            label20.ForeColor = Color.Black;
        }

        private void label20_MouseMove(object sender, MouseEventArgs e)
        {
            label20.ForeColor = Color.Blue;

        }

        private void label20_Click(object sender, EventArgs e)
        {
            txt_z2.Text = GV.PrintingObj.Status.fPosZ.ToString("0.000");
        }

        int valueP = PRESSURE_ERR;
        int nNotReplay = 0;

        private void seriPortSensor1_DataReceived(object sender, System.IO.Ports.SerialDataReceivedEventArgs e)
        {
            try
            {
                nNotReplay = 0;

                // 监测压力值
                byte[] readBuff = new byte[10];
                seriPortSensor1.Read(readBuff, 0, 10);

                // BB BB BB 01 A1 XX XX 01 FF E5
                if (readBuff[0] == 187 && readBuff[1] == 187 && readBuff[2] == 187 && readBuff[3] == 1 && readBuff[4] == 161)
                {
                    valueP = readBuff[5] * 256 + readBuff[6];
                    valueP = Convert.ToInt16(valueP.ToString("X4"), 16);
                }
                // BB BB BB 01 A2 00 00 XX XX XX
                else if (readBuff[0] == 187 && readBuff[1] == 187 && readBuff[2] == 187 && readBuff[3] == 1 && readBuff[4] == 162)
                {
                    valueP = 0;
                }
            }
            catch (Exception ex)
            {
                valueP = PRESSURE_ERR;
            }
        }

        private void btnMove2ReadyPos_MouseMove(object sender, MouseEventArgs e)
        {
            double x, y, z;
            if (rdbNozzle2.Checked)
            {
                x = GV.X_ADJUST_B;
                y = GV.Y_ADJUST_B;
                z = GV.Z_ADJUST_B - 5; // 预留5mm安全距离
            }
            else
            {
                x = GV.X_ADJUST;
                y = GV.Y_ADJUST;
                z = GV.Z_ADJUST - 5; // 预留5mm安全距离
            }
            lblReadyPos.Text = "(" + x.ToString("0.000") + ", " + y.ToString("0.000") + ", " + z.ToString("0.000") + ")";
            lblReadyPos.Show();
        }

        private void btnMove2ReadyPos_MouseLeave(object sender, EventArgs e)
        {
            lblReadyPos.Text = "";
            lblReadyPos.Hide();
        }

        private void btnMove2InitPos_MouseMove(object sender, MouseEventArgs e)
        {
            CalcuZ_BOTTOM();
            double zPos;
            if (GV.PrintingObj.Status.fPosZ > GV.Z_TOP)
            {
                zPos = GV.Z_TOP;
            }
            else
            {
                zPos = GV.PrintingObj.Status.fPosZ;
            }
            lblInitPos.Text = "(" + GV.X_INIT.ToString("0.000") + ", " + GV.Y_INIT.ToString("0.000") + ", " + zPos.ToString("0.000") + ")";
            lblInitPos.Show();
        }

        private void btnMove2InitPos_MouseLeave(object sender, EventArgs e)
        {
            lblInitPos.Text = "";
            lblInitPos.Hide();
        }

        private void txt_z0_TextChanged(object sender, EventArgs e)
        {
            GV.Z_BOTTOM = Convert.ToDouble(txt_z0.Text);
        }

        private void btnMove2ReadyPos_MouseDown(object sender, MouseEventArgs e)
        {
            //if (GV.PrintingObj.NoticeInfo == "PositionReady" && GV.PrintingObj.Status.fPosZ >= GV.Z_ADJUST)
            //{
            if (e.Button == System.Windows.Forms.MouseButtons.Right)
            {
                JogMove(1);
            }

            //}
        }

        private void btnMove2ReadyPos_MouseUp(object sender, MouseEventArgs e)
        {
            JogMove_Stop();
        }

        private void btnGetCenterPoint_Click(object sender, EventArgs e)
        {

        }

        private void lblAdjust_Click(object sender, EventArgs e)
        {
            Control ctrl = sender as Control;
            switch (ctrl.Name.Substring(ctrl.Name.Length - 1, 1))
            {
                case "A":
                    txtAdjustX_A.Text = GV.PrintingObj.Status.fPosX.ToString("0.000");
                    txtAdjustY_A.Text = GV.PrintingObj.Status.fPosY.ToString("0.000");
                    txtAdjustZ_A.Text = GV.PrintingObj.Status.fPosZ.ToString("0.000");
                    break;
                case "B":
                    txtAdjustX_B.Text = GV.PrintingObj.Status.fPosX.ToString("0.000");
                    txtAdjustY_B.Text = GV.PrintingObj.Status.fPosY.ToString("0.000");
                    txtAdjustZ_B.Text = GV.PrintingObj.Status.fPosZ.ToString("0.000");
                    break;
                default:
                    txtAdjustX_A.Text = GV.PrintingObj.Status.fPosX.ToString("0.000");
                    txtAdjustY_A.Text = GV.PrintingObj.Status.fPosY.ToString("0.000");
                    txtAdjustZ_A.Text = GV.PrintingObj.Status.fPosZ.ToString("0.000");
                    break;
            }
            SetAdjustPos();
        }

        private void txtAdjust_TextChanged(object sender, EventArgs e)
        {
            TextBox txt = sender as TextBox;
            try
            {
                double Xa = Convert.ToDouble(txtAdjustX_A.Text);
                double Ya = Convert.ToDouble(txtAdjustY_A.Text);
                double Za = Convert.ToDouble(txtAdjustZ_A.Text);
                double Xb = Convert.ToDouble(txtAdjustX_B.Text);
                double Yb = Convert.ToDouble(txtAdjustY_B.Text);
                double Zb = Convert.ToDouble(txtAdjustZ_B.Text);
                txtDX_ab.Text = (Xb - Xa).ToString("0.000");
                txtDY_ab.Text = (Yb - Ya).ToString("0.000");
                txtDZ_ab.Text = (Zb - Za).ToString("0.000");
            }
            catch (Exception ex)
            {
                lblNotice.Text = ex.Message;
                txt.Focus();
            }
        }

        private void label29_Click(object sender, EventArgs e)
        {
            txtVar_z2.Text = GV.PrintingObj.Status.fPosZ.ToString("0.000");
        }

        public void SetNozzle(int nozzleID)
        {
            if (nozzleID == 0)
            {
                rdbNozzle1.Checked = true;
            }
            else
            {
                rdbNozzle2.Checked = true;
            }
        }

        private void rdbNozzle1_CheckedChanged(object sender, EventArgs e)
        {
            GetAdjustZ();
        }

        private void rdbNozzle2_CheckedChanged(object sender, EventArgs e)
        {
            GetAdjustZ();
        }

        private void txtVar_z2_TextChanged(object sender, EventArgs e)
        {
            try
            {
                TextBox txtPos = sender as TextBox;
                double value = Convert.ToDouble(txtPos.Text);
                CalcuZ_BOTTOM();
            }
            catch (Exception)
            {
                (sender as Control).Focus();
            }
        }

        private void btnGetCenterPoint_Click_1(object sender, EventArgs e)
        {
            try
            {
                if (rdbNozzle1.Checked)
                {
                    txtAdjustX_A.Text = centerPoint[0].ToString("0.000");
                    txtAdjustY_A.Text = centerPoint[1].ToString("0.000");
                    txtAdjustZ_A.Text = centerPoint[2].ToString("0.000");
                    txtVar_z2.Text = txtAdjustZ_A.Text;
                }
                else
                {
                    txtAdjustX_B.Text = centerPoint[0].ToString("0.000");
                    txtAdjustY_B.Text = centerPoint[1].ToString("0.000");
                    txtAdjustZ_B.Text = centerPoint[2].ToString("0.000");
                    txtVar_z2.Text = txtAdjustZ_B.Text;
                }
                GV.X_ADJUST = Convert.ToDouble(txtAdjustX_A.Text);
                GV.Y_ADJUST = Convert.ToDouble(txtAdjustY_A.Text);
                GV.Z_ADJUST = Convert.ToDouble(txtAdjustZ_A.Text);
                GV.X_ADJUST_B = Convert.ToDouble(txtAdjustX_B.Text);
                GV.Y_ADJUST_B = Convert.ToDouble(txtAdjustY_B.Text);
                GV.Z_ADJUST_B = Convert.ToDouble(txtAdjustZ_B.Text);
                SaveParameters();
            }
            catch (Exception ex)
            {
            }
        }

        private void btnGetCenterPoint_MouseMove(object sender, MouseEventArgs e)
        {
            centerPoint = GV.PrintingObj.GetLaserCenter();
            if (centerPoint != null)
            {
                if (centerPoint.Length == 3)
                {
                    lblCenterPoint.Text = "(" + centerPoint[0].ToString("0.000") + ", " + centerPoint[1].ToString("0.000") + ", " + centerPoint[2].ToString("0.000") + ")";
                    lblCenterPoint.Show();
                }
            }
        }

        private void btnGetCenterPoint_MouseLeave(object sender, EventArgs e)
        {
            lblCenterPoint.Text = "";
            lblCenterPoint.Hide();
        }

        private void rdbNozzle1_Click(object sender, EventArgs e)
        {
            if (GV.PrintingObj.Status.nozzleID == 1) // 当前为喷头B，将切换为喷头A
            {
                if (DialogResult.OK == MessageBox.Show("当前为右喷头，确定切换到左喷头吗？", "提示", MessageBoxButtons.OKCancel))
                {
                    GV.PrintingObj.Status.nozzleID = 0;
                    GV.PrintingObj.qExtrude(2, 0); // 喷头B气动提升
                    GV.PrintingObj.qPause(1000);    // 等待喷头气动停稳
                    GV.PrintingObj.qMoveAxisRelative(GV.Z, -GV.dZ_AB, 5); // Z轴缓慢下降至预设位置。
                    //GetAdjustZ();
                }
            }
        }

        private void rdbNozzle2_Click(object sender, EventArgs e)
        {
            if (GV.PrintingObj.Status.nozzleID == 0)
            {
                if (DialogResult.OK == MessageBox.Show("当前为左喷头，确定切换到右喷头吗？", "提示", MessageBoxButtons.OKCancel))
                {
                    GV.PrintingObj.Status.nozzleID = 1;
                    GV.PrintingObj.qMoveAxisRelative(GV.Z, GV.dZ_AB - 5, 10); // Z轴留5mm余量，给喷头B气动下降留缓冲余地。
                    GV.PrintingObj.qWaitMoveEnd();
                    GV.PrintingObj.qExtrude(2, 1);  // 喷头B气动下降
                    GV.PrintingObj.qPause(1000);    // 等待喷头气动降下停稳
                    GV.PrintingObj.qMoveAxisRelative(GV.Z, 5, 10); // Z轴在缓冲区继续下降
                    //rdbNozzle2.Checked = true;
                    GetAdjustZ();
                }
            }
        }

        private void label11_Click(object sender, EventArgs e)
        {
            txtInitX.Text = GV.PrintingObj.Status.fPosX.ToString("0.000");
            txtInitY.Text = GV.PrintingObj.Status.fPosY.ToString("0.000");
            SetInitPos();
        }

        private void label11_MouseMove(object sender, MouseEventArgs e)
        {
            label11.ForeColor = Color.Blue;
        }

        private void label11_MouseLeave(object sender, EventArgs e)
        {
            label11.ForeColor = Color.Black;
        }

        private void txt_z0_TextChanged_1(object sender, EventArgs e)
        {
            txtInitZ.Text = txt_z0.Text;
            GV.frmMotionAdjust.SetTxtZBottom(txt_z0.Text);
        }

        private void btnCleanNozzle_Click(object sender, EventArgs e)
        {
            int IsCleanning = GV.PrintingObj.GetExtrudePort(3);
            GV.PrintingObj.Extrude(3, 1 - IsCleanning);
        }

        private void label45_Click(object sender, EventArgs e)
        {
            txtCleanX.Text = GV.PrintingObj.Status.fPosX.ToString("0.000");
            txtCleanY.Text = GV.PrintingObj.Status.fPosY.ToString("0.000");
            txtCleanZ.Text = GV.PrintingObj.Status.fPosZ.ToString("0.000");
        }

        private void label28_Click(object sender, EventArgs e)
        {

        }

        private void button3_Click(object sender, EventArgs e)
        {
            Move2ReadyPos(xClean, yClean, zClean, "PrintReady");
            //// 开始出丝
            GV.PrintingObj.qWaitMoveEnd();
            GV.PrintingObj.Extrude(3, 1);
            GV.PrintingObj.qPause(5000);
            Move2ReadyPos(xClean, yClean, zClean, "PrintReady");
        }

        private void label57_Click(object sender, EventArgs e)
        {
            txtCameraX.Text = GV.PrintingObj.Status.fPosX.ToString("0.000");
            txtCameraY.Text = GV.PrintingObj.Status.fPosY.ToString("0.000");
            txtCameraZ.Text = GV.PrintingObj.Status.fPosZ.ToString("0.000");
        }

        private void label53_Click(object sender, EventArgs e)
        {
            txtNozzleX.Text = GV.PrintingObj.Status.fPosX.ToString("0.000");
            txtNozzleY.Text = GV.PrintingObj.Status.fPosY.ToString("0.000");
            txtNozzleZ.Text = GV.PrintingObj.Status.fPosZ.ToString("0.000");
        }

        private void label61_Click(object sender, EventArgs e)
        {

        }

        private void txtCamera_Leave(object sender, EventArgs e)
        {
            try
            {
                double dx = Convert.ToDouble(txtNozzleX.Text) - Convert.ToDouble(txtCameraX.Text);
                double dy = Convert.ToDouble(txtNozzleY.Text) - Convert.ToDouble(txtCameraY.Text);
                double dz = Convert.ToDouble(txtNozzleZ.Text) - Convert.ToDouble(txtCameraZ.Text);
            }
            catch (Exception ex)
            {
                TextBox txt = (sender as TextBox);
                txt.Focus();
                //txt.SelectAll();
            }
        }

        private void btnSavePara_Click(object sender, EventArgs e)
        {
            SaveParameters();
        }

        private void btnCameraPosCalibrate_Click(object sender, EventArgs e)
        {
            try
            {
                double dx = Convert.ToDouble(txtNozzleX.Text) - Convert.ToDouble(txtCameraX.Text);
                double dy = Convert.ToDouble(txtNozzleY.Text) - Convert.ToDouble(txtCameraY.Text);
                double dz = Convert.ToDouble(txtNozzleZ.Text) - Convert.ToDouble(txtCameraZ.Text);
                if (dz >= 0)
                {
                    txtCameradX.Text = dx.ToString("0.000");
                    txtCameradY.Text = dy.ToString("0.000");
                    txtCameradZ.Text = dz.ToString("0.000");
                    GV.dX_Camera = dx;
                    GV.dY_Camera = dy;
                    GV.dZ_Camera = dz;
                }
                else
                {
                    MessageBox.Show("摄像头位置必须必针头位置高，否则拍照时有可能撞击打印基底，或损坏已打印样品", "警告");
                    txtCameraZ.Focus();
                }
            }
            catch (Exception ex)
            {
            }
        }

        private void btnCalibrateClean_Click(object sender, EventArgs e)
        {
            double xClean = 0, yClean = 0, zClean = 0;
            double xAdjust, yAdjust, zAdjust;
            try
            {
                if (rdbNozzle1.Checked)  //喷头1启用状态
                {
                    xAdjust = GV.X_ADJUST;
                    yAdjust = GV.Y_ADJUST;
                    zAdjust = GV.Z_ADJUST;
                }
                else
                {
                    xAdjust = GV.X_ADJUST_B;
                    yAdjust = GV.Y_ADJUST_B;
                    zAdjust = GV.Z_ADJUST_B;
                }
                xClean = Convert.ToDouble(txtCleanX.Text);
                yClean = Convert.ToDouble(txtCleanY.Text);
                zClean = Convert.ToDouble(txtCleanZ.Text);

                GV.dX_Clean = xClean - xAdjust;
                GV.dY_Clean = yClean - yAdjust;
                GV.dZ_Clean = zClean - zAdjust;

                txtCleandX.Text = GV.dX_Clean.ToString("0.000");
                txtCleandY.Text = GV.dY_Clean.ToString("0.000");
                txtCleandZ.Text = GV.dZ_Clean.ToString("0.000");


            }
            catch (Exception ex)
            {
            }

        }

        double xClean = 0, yClean = 0, zClean = 0;
        private void button3_MouseMove(object sender, MouseEventArgs e)
        {

            double xAdjust, yAdjust, zAdjust;
            try
            {
                if (rdbNozzle1.Checked)  //喷头1启用状态
                {
                    xAdjust = GV.X_ADJUST;
                    yAdjust = GV.Y_ADJUST;
                    zAdjust = GV.Z_ADJUST;
                }
                else
                {
                    xAdjust = GV.X_ADJUST_B;
                    yAdjust = GV.Y_ADJUST_B;
                    zAdjust = GV.Z_ADJUST_B;
                }
                xClean = xAdjust + GV.dX_Clean;
                yClean = yAdjust + GV.dY_Clean;
                zClean = zAdjust + GV.dZ_Clean;

                label63.Text = "(" + xClean.ToString("0.000") + ", " + yClean.ToString("0.000") + ", " + zClean.ToString("0.000") + ")";
                label63.Show();
            }
            catch (Exception ex)
            {
            }

        }


        private void button3_MouseLeave(object sender, EventArgs e)
        {
            label63.Text = "";
            label63.Hide();
        }

        private void button5_Click(object sender, EventArgs e)
        {
            try
            {
                GV.dX_Clean = Convert.ToDouble(txtCleandX.Text);
                GV.dY_Clean = Convert.ToDouble(txtCleandY.Text);
                GV.dZ_Clean = Convert.ToDouble(txtCleandZ.Text);
                SaveParameters();
            }
            catch (Exception ex)
            {
            }
        }

        //******************************************************************************************************************//
        //相机对针

        /// <summary>
        /// 大恒相机
        /// </summary>     

        bool m_bIsOpen = false;                           ///<设备打开状态
        bool m_bIsSnap = false;                           ///<发送开采命令标识
        bool m_bTriggerMode = false;                           ///<是否支持触发模式
        bool m_bTriggerActive = false;                           ///<是否支持触发极性
        bool m_bTriggerSource = false;                           ///<是否支持触发源 
        bool m_bWhiteAuto = false;                           ///<标识是否支持白平衡
        bool m_bBalanceRatioSelector = false;                           ///<标识是否支持白平衡通道
        bool m_bWhiteAutoSelectedIndex = true;                            ///<白平衡列表框转换标志
        IGXFactory m_objIGXFactory = null;                            ///<Factory对像
        IGXDevice m_objIGXDevice = null;                            ///<设备对像
        IGXStream m_objIGXStream = null;                            ///<流对像
        IGXFeatureControl m_objIGXFeatureControl = null;                            ///<远端设备属性控制器对像
        IGXFeatureControl m_objIGXStreamFeatureControl = null;                            ///<流层属性控制器对象
        string m_strBalanceWhiteAutoValue = "Off";                           ///<自动白平衡当前的值
        GxBitmap m_objGxBitmap = null;                            ///<图像显示类对象
        string m_strFilePath = "";                              ///<应用程序当前路径

        private bool singleSnap = false;//单次采集
        List<IGXDeviceInfo> listGXDeviceInfo = new List<IGXDeviceInfo>();
        private void UpdateUI()
        {

        }
        /// <summary>
        /// 相机初始化
        /// </summary>
        void InitDevice()
        {
            if (null != m_objIGXFeatureControl)
            {
                //设置采集模式连续采集
                m_objIGXFeatureControl.GetEnumFeature("AcquisitionMode").SetValue("Continuous");
            }
        }

        /// <summary>
        /// 关闭流
        /// </summary>
        private void CloseStream()
        {
            try
            {
                //关闭流
                if (null != m_objIGXStream)
                {
                    m_objIGXStream.Close();
                    m_objIGXStream = null;
                    m_objIGXStreamFeatureControl = null;
                }
            }
            catch (Exception)
            {
            }
        }

        /// <summary>
        /// 关闭设备
        /// </summary>
        private void CloseDevice()
        {
            try
            {
                //关闭设备
                if (null != m_objIGXDevice)
                {
                    m_objIGXDevice.Close();
                    m_objIGXDevice = null;
                }
            }
            catch (Exception)
            {
            }
        }
        /// <summary>
        /// 设备打开后初始化界面，初始配置参数
        /// </summary>
        private void InitUI()
        {
            InitEnumComBoxUI(m_cb_TriggerMode, "TriggerMode", m_objIGXFeatureControl, ref m_bTriggerMode);                      //触发模式初始化
            InitEnumComBoxUI(m_cb_TriggerSource, "TriggerSource", m_objIGXFeatureControl, ref m_bTriggerSource);                //触发源初始化
            InitEnumComBoxUI(m_cb_TriggerActivation, "TriggerActivation", m_objIGXFeatureControl, ref m_bTriggerActive);        //触发极性初始化
            InitShutterUI();                                                                                                    //曝光初始化
            InitGainUI();                                                                                                       //增益的初始化
            CleanBalanceUI();                                                                                                   //清除白平衡相关控件
            InitWhiteRatioUI();                                                                                                 //初始化白平衡系数相关控件
            InitEnumComBoxUI(m_cb_AutoWhite, "BalanceWhiteAuto", m_objIGXFeatureControl, ref m_bWhiteAuto);                     //自动白平衡的初始化
            InitEnumComBoxUI(m_cb_RatioSelector, "BalanceRatioSelector", m_objIGXFeatureControl, ref m_bBalanceRatioSelector);  //白平衡通道选择


            //获取白平衡当前的值
            bool bIsImplemented = false;             //是否支持
            bool bIsReadable = false;                //是否可读
            // 获取是否支持
            if (null != m_objIGXFeatureControl)
            {
                bIsImplemented = m_objIGXFeatureControl.IsImplemented("BalanceWhiteAuto");
                bIsReadable = m_objIGXFeatureControl.IsReadable("BalanceWhiteAuto");
                if (bIsImplemented)
                {
                    if (bIsReadable)
                    {
                        //获取当前功能值
                        m_strBalanceWhiteAutoValue = m_objIGXFeatureControl.GetEnumFeature("BalanceWhiteAuto").GetValue();
                    }
                }
            }
        }
        //打开相机，并开始采集图像
        private void btnConnect2Camera_Click(object sender, EventArgs e)
        {
            if (btnConnect2Camera.Text == "连接至相机")
            {
                try
                {
                    //打开设备
                    if (openDevice(listGXDeviceInfo[cmbEnumDevice.SelectedIndex])) ;
                    {
                        btnConnect2Camera.Text = "关闭相机";
                        if (null != m_objIGXStreamFeatureControl)
                        {
                            try
                            {
                                //设置流层Buffer处理模式为OldestFirst
                                m_objIGXStreamFeatureControl.GetEnumFeature("StreamBufferHandlingMode").SetValue("OldestFirst");
                            }
                            catch (Exception)
                            {
                            }
                        }
                        //开启采集流通道
                        if (null != m_objIGXStream)
                        {
                            //RegisterCaptureCallback第一个参数属于用户自定参数(类型必须为引用
                            //类型)，若用户想用这个参数可以在委托函数中进行使用
                            m_objIGXStream.RegisterCaptureCallback(this, __CaptureCallbackPro);
                            m_objIGXStream.StartGrab();
                        }

                        //发送开采命令
                        if (null != m_objIGXFeatureControl)
                        {
                            m_objIGXFeatureControl.GetCommandFeature("AcquisitionStart").Execute();
                        }
                        m_bIsSnap = true;

                    }
                    //UpdateUI();
                }
                catch (Exception ex)
                {
                    MessageBox.Show(ex.Message);
                }
            }
            else if (m_bIsOpen || m_bIsSnap && btnConnect2Camera.Text == "关闭相机")
            {
                try
                {
                    //发送停采命令
                    if (null != m_objIGXFeatureControl)
                    {
                        m_objIGXFeatureControl.GetCommandFeature("AcquisitionStop").Execute();
                    }

                    //关闭采集流通道
                    if (null != m_objIGXStream)
                    {
                        m_objIGXStream.StopGrab();
                        //注销采集回调函数
                        m_objIGXStream.UnregisterCaptureCallback();
                    }
                    m_objIGXStream.Close();
                    m_objIGXStream = null;
                    m_objIGXStreamFeatureControl = null;

                    m_bIsSnap = false;

                    // 更新界面UI
                    //UpdateUI();
                    try
                    {
                        //关闭设备
                        if (null != m_objIGXDevice)
                        {
                            m_objIGXDevice.Close();
                            m_objIGXDevice = null;
                        }
                    }
                    catch (Exception)
                    {

                    }
                    m_bIsOpen = false;
                    btnConnect2Camera.Text = "连接至相机";

                }
                catch (Exception ex)
                {
                    MessageBox.Show(ex.Message);
                }
            }
        }

        //搜索设备
        private void lblSearchDevice_Click(object sender, EventArgs e)
        {
            try
            {
                //刷新界面
                UpdateUI();

                m_objIGXFactory = IGXFactory.GetInstance();
                m_objIGXFactory.Init();
                m_objIGXFactory.UpdateAllDeviceList(500, listGXDeviceInfo);

                // 判断当前连接设备个数
                if (listGXDeviceInfo.Count <= 0)
                {
                    // MessageBox.Show("未发现设备!");
                    return;
                }

                //更新在combox
                cmbEnumDevice.Items.Clear();
                for (int i = 0; i < listGXDeviceInfo.Count; i++)
                {
                    cmbEnumDevice.Items.Add(listGXDeviceInfo[i].GetDisplayName());
                }
                cmbEnumDevice.SelectedIndex = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
        }
        private bool openDevice(IGXDeviceInfo targetCam)
        {
            try
            {
                List<IGXDeviceInfo> listGXDeviceInfo = new List<IGXDeviceInfo>();

                //关闭流
                CloseStream();
                // 如果设备已经打开则关闭，保证相机在初始化出错情况下能再次打开
                CloseDevice();

                //// 如果设备已经打开则关闭，保证相机在初始化出错情况下能再次打开
                //if (null != m_objIGXDevice)
                //{
                //    m_objIGXDevice.Close();
                //    m_objIGXDevice = null;
                //}

                //打开设备
                m_objIGXDevice = m_objIGXFactory.OpenDeviceBySN(targetCam.GetSN(), GX_ACCESS_MODE.GX_ACCESS_EXCLUSIVE);
                m_objIGXFeatureControl = m_objIGXDevice.GetRemoteFeatureControl();

                //打开流
                if (null != m_objIGXDevice)
                {
                    m_objIGXStream = m_objIGXDevice.OpenStream(0);
                    m_objIGXStreamFeatureControl = m_objIGXStream.GetFeatureControl();
                }

                // 建议用户在打开网络相机之后，根据当前网络环境设置相机的流通道包长值，
                // 以提高网络相机的采集性能,设置方法参考以下代码。
                GX_DEVICE_CLASS_LIST objDeviceClass = m_objIGXDevice.GetDeviceInfo().GetDeviceClass();
                if (GX_DEVICE_CLASS_LIST.GX_DEVICE_CLASS_GEV == objDeviceClass)
                {
                    // 判断设备是否支持流通道数据包功能
                    if (true == m_objIGXFeatureControl.IsImplemented("GevSCPSPacketSize"))
                    {
                        // 获取当前网络环境的最优包长值
                        uint nPacketSize = m_objIGXStream.GetOptimalPacketSize();
                        // 将最优包长值设置为当前设备的流通道包长值
                        m_objIGXFeatureControl.GetIntFeature("GevSCPSPacketSize").SetValue(nPacketSize);
                    }
                }

                //初始化相机参数
                InitDevice();

                // 获取相机参数,初始化界面控件
                InitUI();

                if (null != m_objGxBitmap)
                {
                    m_objGxBitmap.ReleaseBuffer();
                    m_objGxBitmap = null;
                }
                m_objGxBitmap = new GxBitmap(m_objIGXDevice, pic_ShowImage, m_objIGXStream, m_objIGXFactory);

                // 更新设备打开标识
                m_bIsOpen = true;

            }
            catch (Exception ex)
            {
                // 发生异常时，清理所有相关对象，防止残留状态
                m_objIGXDevice = null;
                m_objIGXFeatureControl = null;
                m_objIGXStream = null;
                m_objIGXStreamFeatureControl = null;
                if (m_objGxBitmap != null)
                {
                    m_objGxBitmap.ReleaseBuffer();
                    m_objGxBitmap = null;
                }
                m_bIsOpen = false;

                MessageBox.Show(ex.Message);
            }
            return m_bIsOpen;
        }

        /// <summary>
        /// 枚举型功能ComBox界面初始化
        /// </summary>
        /// <param name="cbEnum">ComboBox控件名称</param>
        /// <param name="strFeatureName">枚举型功能名称</param>
        /// <param name="objIGXFeatureControl">属性控制器对像</param>
        /// <param name="bIsImplemented">是否支持</param>
        private void InitEnumComBoxUI(System.Windows.Forms.ComboBox cbEnum, string strFeatureName, IGXFeatureControl objIGXFeatureControl, ref bool bIsImplemented)
        {
            string strTriggerValue = "";                   //当前选择项
            List<string> list = new List<string>();   //Combox将要填入的列表
            bool bIsReadable = false;                //是否可读
            bool bIsWrite = false;
            // 获取是否支持
            if (null != objIGXFeatureControl)
            {
                bIsImplemented = objIGXFeatureControl.IsImplemented(strFeatureName);
                // 如果不支持则直接返回
                if (!bIsImplemented)
                {
                    return;
                }

                bIsReadable = objIGXFeatureControl.IsReadable(strFeatureName);

                if (bIsReadable)
                {
                    list.AddRange(objIGXFeatureControl.GetEnumFeature(strFeatureName).GetEnumEntryList());
                    //获取当前功能值
                    strTriggerValue = objIGXFeatureControl.GetEnumFeature(strFeatureName).GetValue();
                }

                bIsWrite = objIGXFeatureControl.IsWritable(strFeatureName);
                // 如果不可写则直接返回
                if (!bIsWrite)
                {
                    bIsImplemented = false;
                    return;
                }
            }

            //清空组合框并更新数据到窗体
            cbEnum.Items.Clear();
            foreach (string str in list)
            {
                cbEnum.Items.Add(str);
            }

            //获得相机值和枚举到值进行比较，刷新对话框
            for (int i = 0; i < cbEnum.Items.Count; i++)
            {
                string strTemp = cbEnum.Items[i].ToString();
                if (strTemp == strTriggerValue)
                {
                    cbEnum.SelectedIndex = i;
                    break;
                }
            }
        }

        /// <summary>
        /// 曝光控制界面初始化
        /// </summary>
        private void InitShutterUI()
        {
            double dCurShuter = 0.0;                       //当前曝光值
            double dMin = 0.0;                       //最小值
            double dMax = 0.0;                       //最大值
            string strUnit = "";                        //单位
            string strText = "";                        //显示内容

            //获取当前相机的曝光值、最小值、最大值和单位
            if (null != m_objIGXFeatureControl)
            {
                dCurShuter = m_objIGXFeatureControl.GetFloatFeature("ExposureTime").GetValue();
                dMin = m_objIGXFeatureControl.GetFloatFeature("ExposureTime").GetMin();
                dMax = m_objIGXFeatureControl.GetFloatFeature("ExposureTime").GetMax();
                strUnit = m_objIGXFeatureControl.GetFloatFeature("ExposureTime").GetUnit();
            }

            //刷新曝光范围及单位到界面上
            strText = string.Format("曝光时间({0}~{1}){2}", dMin.ToString("0.00"), dMax.ToString("0.00"), strUnit);
            m_lbl_Shutter.Text = strText;

            //当前的曝光值刷新到曝光的编辑框
            m_txt_Shutter.Text = dCurShuter.ToString("0.00");
        }

        /// <summary>
        /// 增益控制界面初始化
        /// </summary>
        private void InitGainUI()
        {
            double dCurGain = 0;             //当前增益值
            double dMin = 0.0;           //最小值
            double dMax = 0.0;           //最大值
            string strUnit = "";            //单位
            string strText = "";            //显示内容

            //获取当前相机的增益值、最小值、最大值和单位
            if (null != m_objIGXFeatureControl)
            {
                dCurGain = m_objIGXFeatureControl.GetFloatFeature("Gain").GetValue();
                dMin = m_objIGXFeatureControl.GetFloatFeature("Gain").GetMin();
                dMax = m_objIGXFeatureControl.GetFloatFeature("Gain").GetMax();
                strUnit = m_objIGXFeatureControl.GetFloatFeature("Gain").GetUnit();
            }

            //更新增益值范围到界面
            strText = string.Format("增益({0}~{1}){2}", dMin.ToString("0.00"), dMax.ToString("0.00"), strUnit);
            m_lbl_Gain.Text = strText;

            //当前的增益值刷新到增益的编辑框
            string strCurGain = dCurGain.ToString("0.00");
            m_txt_Gain.Text = strCurGain;
        }
        //开始采集
        private void m_btn_StartDevice_Click(object sender, EventArgs e)
        {
            try
            {
                if (null != m_objIGXStreamFeatureControl)//
                {
                    try
                    {
                        //设置流层Buffer处理模式为OldestFirst,先进先出模式
                        m_objIGXStreamFeatureControl.GetEnumFeature("StreamBufferHandlingMode").SetValue("OldestFirst");
                    }
                    catch (Exception)
                    {
                    }
                }

                //开启采集流通道
                if (null != m_objIGXStream)
                {
                    //RegisterCaptureCallback第一个参数属于用户自定参数(类型必须为引用
                    //类型)，若用户想用这个参数可以在委托函数中进行使用
                    m_objIGXStream.RegisterCaptureCallback(this, __CaptureCallbackPro);
                    m_objIGXStream.StartGrab();
                }

                //发送开采命令
                if (null != m_objIGXFeatureControl)
                {
                    m_objIGXFeatureControl.GetCommandFeature("AcquisitionStart").Execute();
                }
                m_bIsSnap = true;

                // 更新界面UI
                UpdateUI();
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
        }

        /// <summary>
        /// 清空白平衡相关控件
        /// </summary>
        private void CleanBalanceUI()
        {
            //清空自动白平衡

            m_cb_AutoWhite.Items.Clear();
            m_cb_AutoWhite.Text = "";

            //清空自动白平衡通道选择
            m_cb_RatioSelector.Items.Clear();
            m_cb_RatioSelector.Text = "";

            //当前的白平衡文本
            m_lbl_WhiteRatio.Text = "";

            //当前的白平衡系数的编辑框
            m_txt_BalanceRatio.Text = "";
        }
        /// <summary>
        /// 初始化白平衡系数相关控件
        /// </summary>
        private void InitWhiteRatioUI()
        {
            double dWhiteRatio = 0.0;                       //当前曝光值
            double dMin = 0.0;                       //最小值
            double dMax = 0.0;                       //最大值
            string strUnit = "";                        //单位
            string strText = "";                        //显示内容
            bool bIsBalanceRatio = false;                   //是否白平衡是否支持
            //获取当前相机的白平衡系数、最小值、最大值和单位
            if (null != m_objIGXFeatureControl)
            {
                bIsBalanceRatio = m_objIGXFeatureControl.IsImplemented("BalanceRatio");
                bool bBalanceRatioReadable = m_objIGXFeatureControl.IsReadable("BalanceRatio");
                if (!bIsBalanceRatio || !bBalanceRatioReadable)
                {
                    m_txt_BalanceRatio.Enabled = false; ;
                    return;
                }
                dWhiteRatio = m_objIGXFeatureControl.GetFloatFeature("BalanceRatio").GetValue();
                dMin = m_objIGXFeatureControl.GetFloatFeature("BalanceRatio").GetMin();
                dMax = m_objIGXFeatureControl.GetFloatFeature("BalanceRatio").GetMax();
                strUnit = m_objIGXFeatureControl.GetFloatFeature("BalanceRatio").GetUnit();
            }

            //刷新获取白平衡系数范围及单位到界面上
            strText = string.Format("白平衡系数({0}~{1}){2}", dMin.ToString("0.00"), dMax.ToString("0.00"), strUnit);
            m_lbl_WhiteRatio.Text = strText;

            //当前的白平衡系数的编辑框
            m_txt_BalanceRatio.Text = dWhiteRatio.ToString("0.00");
        }
        //停止采集
        private void m_btn_StopDevice_Click(object sender, EventArgs e)
        {
            try
            {

                //发送停采命令
                if (null != m_objIGXFeatureControl)
                {
                    m_objIGXFeatureControl.GetCommandFeature("AcquisitionStop").Execute();
                }

                //关闭采集流通道
                if (null != m_objIGXStream)
                {
                    m_objIGXStream.StopGrab();
                    //注销采集回调函数
                    m_objIGXStream.UnregisterCaptureCallback();
                }

                m_bIsSnap = false;

                // 更新界面UI
                UpdateUI();
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
        }

        //校验距离，保存照片
        private void btnImageSave_Click(object sender, EventArgs e)
        {


            //进行图像保存       
            try
            {
                if (btnImageSave.Text == "校验距离")
                {
                    //tmrOP2_CalibrateNozzle.Start();
                    //打开触发模式
                    string strTriggerMode = "On";
                    SetEnumValue("TriggerMode", strTriggerMode, m_objIGXFeatureControl);

                    //选择软触发
                    string strTriggerSource = "Software";
                    SetEnumValue("TriggerSource", strTriggerSource, m_objIGXFeatureControl);

                    //设置极性
                    string strTriggerActivation = "RisingEdge";
                    SetEnumValue("TriggerActivation", strTriggerActivation, m_objIGXFeatureControl);

                    //发送软触发命令
                    if (null != m_objIGXFeatureControl)
                    {
                        m_objIGXFeatureControl.GetCommandFeature("TriggerSoftware").Execute();
                    }

                    //采集并保存图像
                    singleSnap = true;//单次采集，采集后便保存
                                      //封装一下

                    //关闭触发模式
                    strTriggerMode = "Off";
                    SetEnumValue("TriggerMode", strTriggerMode, m_objIGXFeatureControl);
                    btnImageSave.Text = "结束校验";
                }
                else if (btnImageSave.Text == "结束校验")
                {
                    tmrOP2_CalibrateNozzle.Stop();
                    btnImageSave.Text = "校验距离";
                }

            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
        }

        /// <summary>
        /// 回调函数,用于获取图像信息和显示图像
        /// </summary>
        /// <param name="obj">用户自定义传入参数</param>
        /// <param name="objIFrameData">图像信息对象</param>
        private void __CaptureCallbackPro(object objUserParam, IFrameData objIFrameData)
        {
            try
            {
                FrmNozzleCalibrate objGxSingleCam = objUserParam as FrmNozzleCalibrate;
                if (objGxSingleCam == null) return;
                try
                {
                    objGxSingleCam.ImageShow(objIFrameData);//显示图像
                }
                catch (Exception ex)
                {
                    // 采集显示异常处理
                    objGxSingleCam?.Invoke((MethodInvoker)delegate
                    {
                        MessageBox.Show("图像显示异常: " + ex.Message, "错误", MessageBoxButtons.OK, MessageBoxIcon.Error);

                    });
                    //重置相机流
                    objGxSingleCam?.m_objIGXStream?.StopGrab();
                    objGxSingleCam?.m_objIGXStream?.StartGrab();
                    return;
                }

                if (singleSnap)
                {
                    objGxSingleCam.ImageSave(objIFrameData);//保存图像
                    singleSnap = false;

                    //GV.MsgShow(lblSave, "保存成功", grabTimer, 1000);
                    //lblSave.Text = "保存成功";

                    //// 最好通过Invoke方式更新UI
                    //objGxSingleCam.Invoke((MethodInvoker)delegate
                    //{
                    //    MessageBox.Show("照片保存成功", "提示", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    //});

                }
            }
            catch (Exception)
            {
                singleSnap = false;
            }
        }

        /// <summary>
        /// 图像的显示
        /// </summary
        /// <param name="objIFrameData">图像信息对象</param>
        private void ImageShow(IFrameData objIFrameData)
        {
            try
            {
                m_objGxBitmap.Show(objIFrameData);
            }
            catch (Exception)
            {
            }

            // 是否需要进行图像保存
            // if (m_bSaveBmpImg.Checked)
            if (false)
            {
                DateTime dtNow = System.DateTime.Now;  // 获取系统当前时间
                string strDateTime = dtNow.Year.ToString() + "_"
                                   + dtNow.Month.ToString() + "_"
                                   + dtNow.Day.ToString() + "_"
                                   + dtNow.Hour.ToString() + "_"
                                   + dtNow.Minute.ToString() + "_"
                                   + dtNow.Second.ToString() + "_"
                                   + dtNow.Millisecond.ToString();

                string stfFileName = m_strFilePath + "\\" + strDateTime + ".bmp";  // 默认的图像保存名称
                m_objGxBitmap.SaveBmp(objIFrameData, stfFileName);
            }
        }
    }
    public class MeasurePoint
    {
        public double X;        // 测量点X
        public double Y;        // 测量点Y
        public double Z;        // 测量点Z

        public double ZUp;      // 测量点下针安全位置ZUp
        public bool MeasurePosA = false;//双喷头双工位
        public bool MeasurePosB = false;
        public int numPrintPos;   // 对应的打印工位索引，单喷头6工位
        public double D1 = -1;   // 测量值A
        public double D2 = -1;   // 测量值B
        public double X1 = -1;        // 实际测量点X1
        public double Y1 = -1;        // 实际测量点Y1
        public double Z1 = -1;        // 实际测量点Z1


        public MeasurePoint(double X, double Y, double Z, double ZUp, bool iPrintPosA = false, bool iPrintPosB = false, int iPrintPos = 0)
        {
            this.X = X;
            this.Y = Y;
            this.Z = Z;
            this.ZUp = ZUp;
            this.MeasurePosA = iPrintPosA;//选择工位
            this.MeasurePosB = iPrintPosB;
            this.numPrintPos = iPrintPos;//工位号
        }

        public string ToListText(int index, double measureValueA = -1, double measureValueB = -1)
        {
            string str = "";
            string strMeasureA = "?";
            string strMeasureB = "?";
            string strHeadA = "A :";
            string strHeadB = "B :";
            if (measureValueA > -1 || measureValueB > -1)
            {
                this.D1 = measureValueA;
                this.D2 = measureValueB;
            }
            if (this.MeasurePosA && !this.MeasurePosB)
            {
                if (D1 > -1) // measureValue <= -1
                {
                    // str = stage + index.ToString("00") + ". P" + (numPrintPos) + " (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z1.ToString("000.0") + "): ";
                    str = "A; (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z1.ToString("000.0") + "): ";
                    str += this.D1.ToString("0.0000");
                }
                else
                {
                    //strA = stage + index.ToString("00") + ". P" + (numPrintPos) + " (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z.ToString("000.0") + "): ";
                    str = "A; (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z.ToString("000.0") + "): ";
                    str += "?";
                }
            }
            else if (!this.MeasurePosA && this.MeasurePosB)
            {
                if (D2 > -1) // measureValue <= -1
                {
                    // str = stage + index.ToString("00") + ". P" + (numPrintPos) + " (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z1.ToString("000.0") + "): ";
                    str = "B; (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z1.ToString("000.0") + "): ";
                    str += this.D2.ToString("0.0000");
                }
                else
                {
                    //strA = stage + index.ToString("00") + ". P" + (numPrintPos) + " (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z.ToString("000.0") + "): ";
                    str = "B; (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z.ToString("000.0") + "): ";
                    str += "?";
                }
            }
            else if (this.MeasurePosA && this.MeasurePosB)
            {
                if (D1 > -1 && D2 > -1) // measureValue <= -1
                {
                    // str = stage + index.ToString("00") + ". P" + (numPrintPos) + " (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z1.ToString("000.0") + "): ";
                    str = "A; (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z1.ToString("000.0") + "): ";
                    str += this.D1.ToString("0.0000");
                    str += " ,B: " + this.D2.ToString("0.0000");
                }
                else
                {
                    //strA = stage + index.ToString("00") + ". P" + (numPrintPos) + " (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z.ToString("000.0") + "): ";
                    str = "A; (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z.ToString("000.0") + "): ";
                    str += "?";
                    str += " ,B: ?"; 
                }
            }                   
            //string str;
            //if (measureValue > -1)
            //{
            //    this.D = measureValue;
            //}
            //if (D > -1) // measureValue <= -1
            //{
            //    str = index.ToString("00") + ". P" + (numPrintPos) + " (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z1.ToString("000.0") + "): ";
            //    str += this.D.ToString("0.0000");
            //}
            //else
            //{
            //    str = index.ToString("00") + ". P" + (numPrintPos) + " (" + this.X.ToString("000") + "," + this.Y.ToString("000") + "," + this.Z.ToString("000.0") + "): ";
            //    str += "?";
            //}
            return str;                    
        }

        public string ToPoint()
        {
            return this.X + "," + this.Y + "," + Math.Abs(this.Z - this.ZUp);
        }

        public string ToData(int index)
        {
            return index + "," + this.numPrintPos + "," + this.X + "," + this.Y + "," + this.Z + "," + this.D1;
        }
    }
}



